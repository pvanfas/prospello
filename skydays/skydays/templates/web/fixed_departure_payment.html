{% extends 'web/base.html' %} {% load static extras %} {% block content %}

<div class="newsletter-area section_padding_md pb-5">
    <div class="container">
        <div class="row">

            <div class="col-lg-6 col-sm-12 mx-auto">
                <div class="card-wrapper text-start bg-white">
                    {% if instance.is_paid %}
                    <div class="section-head pb-0">
                        <h2 class="mb-3">Payment<span class="text-orange"> Successful</span></h2>
                       
                    </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table style="width:100%">
                            <tr>
                                <td class="border"><strong>Order ID</strong></td>
                                <td class="border">{{ instance.order_id }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Package</strong></td>
                                <td class="border">{{ instance.departure }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Name</strong></td>
                                <td class="border">{{ instance.name }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Whatsapp</strong></td>
                                <td class="border">{{ instance.whatsapp }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Phone</strong></td>
                                <td class="border">{{ instance.phone }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Email</strong></td>
                                <td class="border">{{ instance.email }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Timestamp</strong></td>
                                <td class="border">{{ instance.timestamp }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Total Payment</strong></td>
                                <td class="border">{{ instance.get_price }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Payment Mode</strong></td>
                                <td class="border">{{ instance.get_payment_method_display }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Is Paid</strong></td>
                                <td class="border">{{ instance.is_paid }}</td>
                            </tr>
                            <tr>
                                <td class="border"><strong>Paid Amount</strong></td>
                                <td class="border">{{ instance.paid_amount|default:"0" }}</td>
                            </tr>

                        </table>
                    </div>
                    
                    <div class="text-center mt-3">
                        {% if instance.is_paid %}
                        <a href="{% url 'web:fixed_departure_pdf' instance.pk %}" target="_blank" class="btn_orange">
                            <svg xmlns="http://www.w3.org/2000/svg" width="800" height="800" fill="#fff" viewBox="0 0 24 24"><path fill="#000" d="M18.22 20.75H5.78A2.638 2.638 0 0 1 3.25 18v-3a.75.75 0 1 1 1.5 0v3a1.16 1.16 0 0 0 1 1.25h12.47a1.16 1.16 0 0 0 1-1.25v-3a.75.75 0 1 1 1.5 0v3a2.64 2.64 0 0 1-2.5 2.75Z"/><path fill="#000" d="M12 15.75a.741.741 0 0 1-.53-.22l-4-4a.75.75 0 0 1 1.06-1.06L12 13.94l3.47-3.47a.75.75 0 0 1 1.06 1.06l-4 4a.738.738 0 0 1-.53.22Z"/><path fill="#000" d="M12 15.75a.76.76 0 0 1-.75-.75V4a.75.75 0 1 1 1.5 0v11a.76.76 0 0 1-.75.75Z"/></svg>
                            Download Voucher
                        </a>
                        {% endif %}
                        <a href="https://wa.me/919072500085?text=*Order%20ID%3A*%20{{instance.order_id}}%0A*Package%3A*%20{{instance.departure}}%0A*Name%3A*%20{{instance.name}}%0A*Whatsapp%3A*%20{{instance.whatsapp}}%0A*Phone%3A*%20{{instance.phone}}%0A*Email%3A*%20{{instance.email}}%0A*Timestamp%3A*%20{{instance.timestamp}}%0A*Total%20Payment%3A*%20{{instance.get_price}}%0A*Payment%20Mode%3A*%20{{instance.get_payment_method_display}}%0A*Is%20Paid%3A*%20{{instance.is_paid}}%0A*Paid%20Amount%3A*%20{{instance.paid_amount}}"
                            class="whatsapp_btn">
                            <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"
                                xmlns:xlink="http://www.w3.org/1999/xlink"
                                style="width: 100%; height: 100%; fill: rgb(255, 255, 255); stroke: none;">
                                <path
                                    d="M19.11 17.205c-.372 0-1.088 1.39-1.518 1.39a.63.63 0 0 1-.315-.1c-.802-.402-1.504-.817-2.163-1.447-.545-.516-1.146-1.29-1.46-1.963a.426.426 0 0 1-.073-.215c0-.33.99-.945.99-1.49 0-.143-.73-2.09-.832-2.335-.143-.372-.214-.487-.6-.487-.187 0-.36-.043-.53-.043-.302 0-.53.115-.746.315-.688.645-1.032 1.318-1.06 2.264v.114c-.015.99.472 1.977 1.017 2.78 1.23 1.82 2.506 3.41 4.554 4.34.616.287 2.035.888 2.722.888.817 0 2.15-.515 2.478-1.318.13-.33.244-.73.244-1.088 0-.058 0-.144-.03-.215-.1-.172-2.434-1.39-2.678-1.39zm-2.908 7.593c-1.747 0-3.48-.53-4.942-1.49L7.793 24.41l1.132-3.337a8.955 8.955 0 0 1-1.72-5.272c0-4.955 4.04-8.995 8.997-8.995S25.2 10.845 25.2 15.8c0 4.958-4.04 8.998-8.998 8.998zm0-19.798c-5.96 0-10.8 4.842-10.8 10.8 0 1.964.53 3.898 1.546 5.574L5 27.176l5.974-1.92a10.807 10.807 0 0 0 16.03-9.455c0-5.958-4.842-10.8-10.802-10.8z">
                                </path>
                            </svg>
                            Chat with Counselor
                        </a>
                    </div>

                </div>
            </div>

            {% if not instance.is_paid %}
            <div class="col-lg-6 col-sm-12">
                <div class="card-wrapper text-start bg-white">
                    <div class="text-center">
                        <h6 class="mb-4 text-start">Proceed to payment of {{payable_inr}} (${{payable_amount}})</h6>
                        <div id="paypal-button-container"></div>
                        <!-- Include the PayPal JavaScript SDK -->
                        <script
                            src="https://www.paypal.com/sdk/js?client-id={{PAYPAL_CLIENT_ID}}&currency=USD"></script>

                        <script>
                            function getCookie(name) {
                                let cookieValue = null;
                                if (document.cookie && document.cookie !== "") {
                                    const cookies = document.cookie.split(";");
                                    for (let i = 0; i < cookies.length; i++) {
                                        const cookie = cookies[i].trim();
                                        // Does this cookie string begin with the name we want?
                                        if (cookie.substring(0, name.length + 1) === name + "=") {
                                            cookieValue = decodeURIComponent(
                                                cookie.substring(name.length + 1)
                                            );
                                            break;
                                        }
                                    }
                                }
                                return cookieValue;
                            };
                            // get csrf token
                            const csrftoken = getCookie("csrftoken");

                            var total = "{{payable_amount}}";
                            var order_id = "{{instance.id}}";
                            var url = "{% url 'web:complete_order' %}"

                            function completeOrder() {
                                fetch(url, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                                    body: JSON.stringify({ 'order_id': order_id, 'total': total })
                                }).then((data) => {
                                    window.location.reload();
                                })
                            }

                            paypal.Buttons({
                                createOrder: function (data, actions) {
                                    return actions.order.create({ purchase_units: [{ amount: { value: total, currency: 'USD' } }] });
                                },
                                onApprove: function (data, actions) {
                                    return actions.order.capture().then(function (orderData) {
                                        console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                                        var transaction = orderData.purchase_units[0].payments.captures[0];
                                        completeOrder();
                                    });
                                }
                            }).render('#paypal-button-container');
                        </script>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

{% endblock %}